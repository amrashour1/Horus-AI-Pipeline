#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
u0633u0643u0631u064au0628u062a u0644u0627u062eu062au0628u0627u0631 u0639u0645u0644u064au0627u062a u0642u0627u0639u062fu0629 u0627u0644u0628u064au0627u0646u0627u062a
"""

import sys
import os
from datetime import datetime

# u0625u0636u0627u0641u0629 u0645u062cu0644u062f u0627u0644u0645u0634u0631u0648u0639 u0625u0644u0649 u0645u0633u0627u0631 u0627u0644u0628u062du062b
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# u0627u0633u062au064au0631u0627u062f u0645u062fu064au0631 u0642u0627u0639u062fu0629 u0627u0644u0628u064au0627u0646u0627u062a
from db_manager import DatabaseManager

def test_db_operations():
    """u0627u062eu062au0628u0627u0631 u0639u0645u0644u064au0627u062a u0642u0627u0639u062fu0629 u0627u0644u0628u064au0627u0646u0627u062a"""
    try:
        # u0625u0646u0634u0627u0621 u0645u062fu064au0631 u0642u0627u0639u062fu0629 u0627u0644u0628u064au0627u0646u0627u062a
        print("u062cu0627u0631u064d u0625u0646u0634u0627u0621 u0645u062fu064au0631 u0642u0627u0639u062fu0629 u0627u0644u0628u064au0627u0646u0627u062a...")
        db_manager = DatabaseManager()
        
        # u0627u062eu062au0628u0627u0631 u0627u0644u0627u062au0635u0627u0644
        print("u062cu0627u0631u064d u0627u062eu062au0628u0627u0631 u0627u0644u0627u062au0635u0627u0644...")
        if not db_manager.test_connection():
            print("u274c u0641u0634u0644 u0627u0644u0627u062au0635u0627u0644 u0628u0642u0627u0639u062fu0629 u0627u0644u0628u064au0627u0646u0627u062a!")
            return False
        print("u2705 u062au0645 u0627u0644u0627u062au0635u0627u0644 u0628u0642u0627u0639u062fu0629 u0627u0644u0628u064au0627u0646u0627u062a u0628u0646u062cu0627u062d!")
        
        # u0625u0646u0634u0627u0621 u062cu0644u0633u0629 u062cu062fu064au062fu0629
        print("\nu062cu0627u0631u064d u0625u0646u0634u0627u0621 u062cu0644u0633u0629 u062cu062fu064au062fu0629...")
        session_id = db_manager.create_session("u062cu0644u0633u0629 u0627u062eu062au0628u0627u0631 u0642u0627u0639u062fu0629 u0627u0644u0628u064au0627u0646u0627u062a")
        if not session_id:
            print("u274c u0641u0634u0644 u0625u0646u0634u0627u0621 u0627u0644u062cu0644u0633u0629!")
            return False
        print(f"u2705 u062au0645 u0625u0646u0634u0627u0621 u062cu0644u0633u0629 u062cu062fu064au062fu0629 u0628u0645u0639u0631u0641: {session_id}")
        
        # u0625u0636u0627u0641u0629 u0631u0633u0627u0626u0644 u0625u0644u0649 u0627u0644u062cu0644u0633u0629
        print("\nu062cu0627u0631u064d u0625u0636u0627u0641u0629 u0631u0633u0627u0626u0644 u0625u0644u0649 u0627u0644u062cu0644u0633u0629...")
        messages = [
            {"sender": "user", "content": "u0645u0631u062du0628u0627u064b! u0643u064au0641 u064au0645u0643u0646u0646u064a u0627u0633u062au062eu062fu0627u0645 u0646u0638u0627u0645 Horus AI Pipelineu061f"},
            {"sender": "ai", "content": "u0645u0631u062du0628u0627u064b u0628u0643! u064au0645u0643u0646u0643 u0627u0633u062au062eu062fu0627u0645 u0627u0644u0646u0638u0627u0645 u0644u0644u062au0641u0627u0639u0644 u0645u0639 u0646u0645u0627u0630u062c u0627u0644u0630u0643u0627u0621 u0627u0644u0627u0635u0637u0646u0627u0639u064a u0627u0644u0645u062eu062au0644u0641u0629."},
            {"sender": "user", "content": "u0645u0627 u0647u064a u0627u0644u0646u0645u0627u0630u062c u0627u0644u0645u062au0627u062du0629u061f"},
            {"sender": "ai", "content": "u0627u0644u0646u0645u0627u0630u062c u0627u0644u0645u062au0627u062du0629 u062au0634u0645u0644 Gemini 1.5/2.5 Flashu060c DeepSeekR1u060c Claude 3.7 Sonnetu060c u0648 GPT-4."},
        ]
        
        for i, msg in enumerate(messages, 1):
            message_id = db_manager.add_message(session_id, msg["sender"], msg["content"])
            if not message_id:
                print(f"u274c u0641u0634u0644 u0625u0636u0627u0641u0629 u0627u0644u0631u0633u0627u0644u0629 {i}!")
                continue
            print(f"u2705 u062au0645u062a u0625u0636u0627u0641u0629 u0627u0644u0631u0633u0627u0644u0629 {i} u0628u0645u0639u0631u0641: {message_id}")
        
        # u0627u0644u062du0635u0648u0644 u0639u0644u0649 u0631u0633u0627u0626u0644 u0627u0644u062cu0644u0633u0629
        print("\nu062cu0627u0631u064d u0627u0633u062au0631u062cu0627u0639 u0631u0633u0627u0626u0644 u0627u0644u062cu0644u0633u0629...")
        session_messages = db_manager.get_session_messages(session_id)
        if not session_messages:
            print("u274c u0644u0645 u064au062au0645 u0627u0644u0639u062bu0648u0631 u0639u0644u0649 u0631u0633u0627u0626u0644 u0641u064a u0627u0644u062cu0644u0633u0629!")
        else:
            print(f"u2705 u062au0645 u0627u0644u0639u062bu0648u0631 u0639u0644u0649 {len(session_messages)} u0631u0633u0627u0626u0644 u0641u064a u0627u0644u062cu0644u0633u0629:")
            for msg in session_messages:
                print(f"  - [{msg['timestamp']}] {msg['sender']}: {msg['content'][:50]}...")
        
        # u0627u0644u062du0635u0648u0644 u0639u0644u0649 u0645u0639u0644u0648u0645u0627u062a u0627u0644u062cu0644u0633u0629
        print("\nu062cu0627u0631u064d u0627u0644u062du0635u0648u0644 u0639u0644u0649 u0645u0639u0644u0648u0645u0627u062a u0627u0644u062cu0644u0633u0629...")
        session_info = db_manager.get_session(session_id)
        if not session_info:
            print("u274c u0644u0645 u064au062au0645 u0627u0644u0639u062bu0648u0631 u0639u0644u0649 u0645u0639u0644u0648u0645u0627u062a u0627u0644u062cu0644u0633u0629!")
        else:
            print("u2705 u0645u0639u0644u0648u0645u0627u062a u0627u0644u062cu0644u0633u0629:")
            for key, value in session_info.items():
                print(f"  - {key}: {value}")
        
        # u0625u0646u0647u0627u0621 u0627u0644u062cu0644u0633u0629
        print("\nu062cu0627u0631u064d u0625u0646u0647u0627u0621 u0627u0644u062cu0644u0633u0629...")
        if db_manager.end_session(session_id):
            print(f"u2705 u062au0645 u0625u0646u0647u0627u0621 u0627u0644u062cu0644u0633u0629 {session_id} u0628u0646u062cu0627u062d!")
        else:
            print(f"u274c u0641u0634u0644 u0625u0646u0647u0627u0621 u0627u0644u062cu0644u0633u0629 {session_id}!")
        
        # u0627u0644u062au062du0642u0642 u0645u0646 u062du0627u0644u0629 u0627u0644u062cu0644u0633u0629 u0628u0639u062f u0627u0644u0625u0646u0647u0627u0621
        print("\nu062cu0627u0631u064d u0627u0644u062au062du0642u0642 u0645u0646 u062du0627u0644u0629 u0627u0644u062cu0644u0633u0629 u0628u0639u062f u0627u0644u0625u0646u0647u0627u0621...")
        session_info = db_manager.get_session(session_id)
        if session_info and session_info['end_time']:
            print(f"u2705 u062au0645 u0627u0644u062au062du0642u0642 u0645u0646 u0625u0646u0647u0627u0621 u0627u0644u062cu0644u0633u0629 u0641u064a: {session_info['end_time']}")
        else:
            print("u274c u0644u0645 u064au062au0645 u062au062du062fu064au062b u0648u0642u062a u0627u0644u0627u0646u062au0647u0627u0621 u0628u0634u0643u0644 u0635u062du064au062d!")
        
        print("\nu2705 u062au0645 u0627u062eu062au0628u0627u0631 u0639u0645u0644u064au0627u062a u0642u0627u0639u062fu0629 u0627u0644u0628u064au0627u0646u0627u062a u0628u0646u062cu0627u062d!")
        return True
    
    except Exception as e:
        print(f"\nu274c u062du062fu062b u062eu0637u0623 u063au064au0631 u0645u062au0648u0642u0639: {e}")
        return False

if __name__ == "__main__":
    print("=== u0627u062eu062au0628u0627u0631 u0639u0645u0644u064au0627u062a u0642u0627u0639u062fu0629 u0628u064au0627u0646u0627u062a Horus AI Pipeline ===")
    success = test_db_operations()
    print("\n" + "=" * 50)
    print(f"\n{'\u2705 u0646u062cu0627u062d u0627u0644u0627u062eu062au0628u0627u0631!' if success else '\u274c u0641u0634u0644 u0627u0644u0627u062eu062au0628u0627u0631!'}")
    sys.exit(0 if success else 1)
